---

layout: default
title: Demo colisión Javascript

---

	<section class="header">
		<div class="container">
			<div class="row">
				<div class="col-md-12">
					<h2>Demo de colisión: Nave espacial</h2>
				</div>
			</div>
		</div>
	</section>

	<section>
		<div class="container">
			<div class="row">
				<div class="col-md-10 col-md-offset-1">
					<p>
						Utiliza las flechas de dirección (arriba, abajo, izquierda, derecha) para mover la nave espacial y llegar a la base azul sin chocar con ningún asteroide (rojos).
					<p>
          <button type="button" class="btn btn-primary btn-sm" onclick="canvasSpaceGame('reset')">Reiniciar</button>
				</div>
				<div class="col-md-10 col-md-offset-1">
					<canvas id="movements" width="300" height="30"></canvas><br>
					<canvas id="game" width="800" height="600"></canvas>
				</div>
			</div>
		</div>
	</section>

	<script type="text/javascript">
		$(document).ready(function() {
			canvasSpaceGame();
		});

	    // Global variables
    	var shipX = 0; // X position of ship
    	var shipY = 0; // Y position of ship
    	var canvas; // canvas
    	var ctx; // game context
      var ctx2; // score context
      var canvasWidth;
      var canvasHeight;
		  var back = new Image(); // storage for new background piece
		  var oldBack = new Image(); // storage for old background piece
		  var ship = new Image(); // ship
		  var bomb = new Image(); // neutralizer ray field
		  var shipX = 0; // current ship position X
		  var shipY = 0; // current ship position Y
		  var oldShipX = 0; // old ship position Y
		  var oldShipY = 0; // old ship position Y
		  var direction = "R"; // direction of ship movement
		  var movements = 50; // movements
		  
      // Called on page load.
      function canvasSpaceGame(option) {

  		  // Get the main canvas element.
        canvas = document.getElementById("game");
        // Get the movements canvas element.
        canvas2 = document.getElementById("movements");

        // Initialize the movements element.
        if (canvas2.getContext) {
          ctx2 = canvas2.getContext("2d");
        }

        // Initialize main element.
        if (canvas.getContext) {
          ctx = canvas.getContext("2d");

          canvasWidth = ctx.canvas.width;
          canvasHeight = ctx.canvas.height;

          // Paint it black.
          ctx.fillStyle = "black";
          ctx.rect(0, 0, canvasWidth, canvasHeight);
          ctx.fill();

          // Save the initial background.
          back = ctx.getImageData(0, 0, 30, 30);

          if (option == 'reset') {
            oldShipX = 0;
            oldShipY = 0;
            shipX = 0;
            shipY = 0;
            movements = 50;
          }

          // Paint the starfield.
          stars();

          // Draw space ship.
          makeShip();

          // Draw asteroids.
          drawAsteroids();

          // Draw movements left
          drawMovements();
        }

        // Play the game until the until the game is over.
        gameLoop = setInterval(doGameLoop, 16);

        // Add keyboard listener.
        window.addEventListener('keydown', whatKey, true);

      }

      // Paint a random star field.
      function stars() {

        // Draw 100 stars.
        for (i = 0; i <= 100; i++) {
          // Get random positions for stars.
          var x = Math.floor(Math.random() * (canvasWidth - 1));
          var y = Math.floor(Math.random() * (canvasHeight - 1));

          // Make the stars white
          ctx.fillStyle = "#EEEEEE";

          // Paint the star but not if too close to ship.
          if (x > 40 && y > 40) {
            ctx.beginPath();
            ctx.arc(x, y, 2, 0, Math.PI * 2, true);
            ctx.closePath();
            ctx.fill();
          } else {
            --i; // So we end having 100 stars
          }
        }

        // Save black background.
        oldBack = ctx.getImageData(0, 0, 30, 30);
      }

      function makeShip() {

        // Draw saucer bottom.
        ctx.beginPath();
        ctx.moveTo(28.4, 16.9);
        ctx.bezierCurveTo(28.4, 19.7, 22.9, 22.0, 16.0, 22.0);
        ctx.bezierCurveTo(9.1, 22.0, 3.6, 19.7, 3.6, 16.9);
        ctx.bezierCurveTo(3.6, 14.1, 9.1, 11.8, 16.0, 11.8);
        ctx.bezierCurveTo(22.9, 11.8, 28.4, 14.1, 28.4, 16.9);
        ctx.closePath();
        ctx.fillStyle = "rgb(222, 103, 0)";
        ctx.fill();

        // Draw saucer top.
        ctx.beginPath();
        ctx.moveTo(22.3, 12.0);
        ctx.bezierCurveTo(22.3, 13.3, 19.4, 14.3, 15.9, 14.3);
        ctx.bezierCurveTo(12.4, 14.3, 9.6, 13.3, 9.6, 12.0);
        ctx.bezierCurveTo(9.6, 10.8, 12.4, 9.7, 15.9, 9.7);
        ctx.bezierCurveTo(19.4, 9.7, 22.3, 10.8, 22.3, 12.0);
        ctx.closePath();
        ctx.fillStyle = "rgb(51, 190, 0)";
        ctx.fill();

        // Save ship data.
        ship = ctx.getImageData(0, 0, 30, 30);

        // Erase it for now.
        ctx.putImageData(oldBack, 0, 0);

      }

      function doGameLoop() {

        // Put old background down to erase shipe.
        ctx.putImageData(oldBack, oldShipX, oldShipY);

        // Put ship in new position.
        ctx.putImageData(ship, shipX, shipY);
      }

      // Get key press.
      function whatKey(evt) {

        // Flag to put variables back if we hit an edge of the board.
        var flag = 0;

        // Get where the ship was before key process.
        oldShipX = shipX;
        oldShipY = shipY;
        oldBack = back;

        switch (evt.keyCode) {

          // Left arrow
          case 37:
            shipX = shipX - 30;
            // If at edge, reset ship position and set flag
            if (shipX < 0) {
              shipX = 0;
              flag = 1;
            }
            direction = "L";
            break;

          // Right arrow
          case 39:
            shipX = shipX + 30;
            // If at edge, reset ship position and set flag
            if (shipX > canvasWidth - 30) {
              shipX = canvasWidth - 30;
              flag = 1;
            }
            direction = "R";
            break;

          // Down arrow
          case 40:
            shipY = shipY + 30;
            // If at edge, reset ship position and set flag
            if (shipY > canvasHeight - 30) {
              shipY = canvasHeight - 30;
              flag = 1;
            }
            direction = "D";
            break;

            // Up arrow 
          case 38:
            shipY = shipY - 30;
            // If at edge, reset ship position and set flag
            if (shipY < 0) {
              shipY = 0;
              flag = 1;
            }
            direction = "U";
            break;

          // If any other keys were presssed
          default:
            flag = 1; // Don't move the ship.
        }

        // If flag is set, the ship did not move
        // Put everything back the way it was
        // Increase movements since the ship did not move
        if (flag) {
          shipX = oldShipX;
          shipY = oldShipY;
          back = oldBack;
          movements = movements + 1;
        } else {
          // Otherwise, get background where the ship will go
          // So you can redraw background when the ship
          // moves again.
          back = ctx.getImageData(shipX, shipY, 30, 30);
        }

        // Decrease movements.
        movements = movements - 1;

        // Draw movements on movementsboard.
        drawMovements();

        // Did we collide?
        collideTest();

        // Prevent the default scrolling from arrow keys
        evt.preventDefault();
      }

      function drawMovements() {
        ctx2.clearRect(0, 0, ctx2.canvas.width, ctx2.canvas.height);
        ctx2.font = "20px Arial";
        ctx2.fillText("Movimientos restantes", 20, 15);
        ctx2.fillText(movements, 250, 15);
      }

      function collideTest() {
        // Collision detection. Get a clip from the screen
        // See what the ship would move over
        var clipWidth = 20;
        var clipDepth = 20;
        var clipLength = clipWidth * clipDepth;
        var clipOffset = 5;
        var whatColor = ctx.getImageData(shipX + clipOffset, shipY + clipOffset, clipWidth, clipDepth);

        // Loop through the clip and see if you find red or blue. 
        for (var i = 0; i < clipLength * 4; i += 4) {
          if (whatColor.data[i] == 255) {
            direction = "P";
            break;
          }
          // Second element is green but we don't care. 
          if (whatColor.data[i + 2] == 255) {
            direction = "B";
            break;
          }
          // Fourth element is alpha and we don't care. 
        }

        // Did we hit something?
        if (direction == "P") bang();
        if (direction == "B") youWin();
        if (movements == 0) outOfMoves();
      }

      function bang() {
        alert("Game over! Un asteroide destruyó tu nave.");
        // Stop game.
        clearTimeout(gameLoop);
        window.removeEventListener('keydown', whatKey, true);
      }

      function youWin() {
        alert("Has ganado! Llegaste a la base.");
        // Stop game.
        clearTimeout(gameLoop);
        window.removeEventListener('keydown', whatKey, true);
      }

      function outOfMoves() {
        alert("Game over! Te has quedado sin movimientos.");
        // Stop game
        clearTimeout(gameLoop);
        window.removeEventListener('keydown', whatKey, true);
      }

      function drawAsteroids() {
      	// Amount of asteroids to draw
      	var amount = canvasWidth / 10;

        // Draw asteroids.
        for (i = 0; i <= amount; i++) {
          // Get random positions for asteroids.
          var a = Math.floor(Math.random() * (canvasWidth - 1));
          var b = Math.floor(Math.random() * (canvasHeight - 1));

          // Keep the asteroids far enough away from
          // the beginning or end
          if (/*beggining*/(a > 60 && b > 60)
            || /*end*/(a < 240 && b < 240)) {
            // Make the asteroids red
            ctx.fillStyle = "#FF0000";

            // Draw an individual asteroid
            ctx.beginPath();
            ctx.arc(a, b, 10, 0, Math.PI * 2, true);
            ctx.closePath();
            ctx.fill();
          } else {
            i--;
          }
        }

        var baseX = ctx.canvas.width - 30;
        var baseY = ctx.canvas.height - 30;
        
        // Draw blue base.
        ctx.fillStyle = "#0000FF";
        ctx.beginPath();
        ctx.rect(baseX, baseY, 30, 30);
        ctx.closePath();
        ctx.fill();

        // Make some room at beginning.
        ctx.putImageData(back, 0, 30);
        ctx.putImageData(back, 30, 0);
        ctx.putImageData(back, 30, 30);
        // Make some room at end.
        ctx.putImageData(back, 240, 240);
        ctx.putImageData(back, 270, 240);
        ctx.putImageData(back, 240, 270);
      }
	</script>